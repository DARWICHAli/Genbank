package Parser;

public class Downloader {
	
	private HttpURLConnection m_connection;
	
    protected BufferedReader get(URL _url) throws IOException, HTTPException {
        // Close previous connection if any
        if (m_connection != null)
            m_connection.disconnect();

        // Initialize request
        try {
            m_connection = (HttpURLConnection) _url.openConnection();
            m_connection.setConnectTimeout(Options.getConnectionTimeout());
            m_connection.setRequestMethod("GET");
        } catch (IOException e) {
            final String message = "Unable to initialize request";
            Logs.warning(message);
            Logs.exception(new IOException(message, e));
            throw e;
        }

        // Execute request
        int statusCode;
        try {
            // Get response code (executes request)
            statusCode = m_connection.getResponseCode();
        } catch (IOException e) {
            final String message = "Unable to establish connection with server";
            Logs.warning(message);
            Logs.exception(new IOException(message, e));
            throw e;
        }

        final BufferedReader in;
        if (statusCode == HttpURLConnection.HTTP_OK) {
            try {
                in = new BufferedReader(new InputStreamReader(m_connection.getInputStream()));
            } catch (IOException e) {
                final String message = "Unable to download data";
                Logs.warning(message);
                Logs.exception(new IOException(message, e));
                throw e;
            }
        } else {
            m_connection.disconnect();
            final String message = "Unable to download data : status " + statusCode;
            Logs.warning(message);
            throw new HTTPException(message);
        }

        return in;
    }
}
